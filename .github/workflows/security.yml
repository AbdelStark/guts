name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday

permissions:
  contents: read
  security-events: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Dependency Audit
  # ============================================================================
  audit:
    name: Cargo Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run audit
        run: cargo audit --deny warnings --json > audit.json || true

      - name: Check for critical vulnerabilities
        run: |
          if cargo audit --deny warnings 2>&1 | grep -q "error"; then
            echo "::error::Critical vulnerabilities found in dependencies"
            exit 1
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: cargo-audit
          path: audit.json

  # ============================================================================
  # Dependency Policy Check (cargo-deny)
  # ============================================================================
  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Check licenses
        run: cargo deny check licenses

      - name: Check bans
        run: cargo deny check bans

      - name: Check advisories
        run: cargo deny check advisories

      - name: Check sources
        run: cargo deny check sources

  # ============================================================================
  # Supply Chain Security - SBOM Generation
  # ============================================================================
  sbom:
    name: SBOM Generation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cargo-sbom
        run: cargo install cargo-sbom --locked

      - name: Generate SBOM (CycloneDX)
        run: cargo sbom --output-format cyclonedx > sbom-cyclonedx.json

      - name: Generate SBOM (SPDX)
        run: cargo sbom --output-format spdx > sbom-spdx.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom-cyclonedx.json
            sbom-spdx.json

  # ============================================================================
  # Reproducible Build Check
  # ============================================================================
  reproducible:
    name: Reproducible Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build with locked dependencies
        run: cargo build --workspace --locked --release
        env:
          CARGO_INCREMENTAL: 0
          RUSTFLAGS: "-C codegen-units=1"

      - name: Verify Cargo.lock unchanged
        run: git diff --exit-code Cargo.lock

  # ============================================================================
  # SAST with CodeQL
  # ============================================================================
  codeql:
    name: CodeQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: rust

      - name: Build
        run: cargo build --workspace

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # ============================================================================
  # Semgrep SAST
  # ============================================================================
  semgrep:
    name: Semgrep
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/rust
            p/security-audit
          generateSarif: true

      - name: Upload Semgrep results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif

  # ============================================================================
  # Container Scanning
  # ============================================================================
  container-scan:
    name: Container Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: docker build -t guts:scan -f infra/docker/Dockerfile .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'guts:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ============================================================================
  # Fuzz Testing (Weekly)
  # ============================================================================
  fuzz:
    name: Fuzz Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz --locked

      - name: Run fuzz targets (30 seconds each)
        run: |
          cd fuzz
          for target in $(cargo fuzz list); do
            echo "Fuzzing $target..."
            timeout 30s cargo +nightly fuzz run "$target" -- -max_total_time=30 || true
          done

      - name: Upload crash artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: fuzz-crashes
          path: fuzz/artifacts/

  # ============================================================================
  # Security Documentation Check
  # ============================================================================
  security-docs:
    name: Security Docs Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check security documentation exists
        run: |
          required_docs=(
            "docs/security/SECURITY.md"
            "docs/security/THREAT_MODEL.md"
            "docs/security/CRYPTOGRAPHY.md"
            "docs/security/AUDIT_SCOPE.md"
          )
          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "::error::Missing required security document: $doc"
              exit 1
            fi
          done
          echo "All required security documents present"

  # ============================================================================
  # Summary Report
  # ============================================================================
  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [audit, deny, sbom, codeql, security-docs]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cargo Audit | ${{ needs.audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cargo Deny | ${{ needs.deny.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM | ${{ needs.sbom.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL | ${{ needs.codeql.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Docs | ${{ needs.security-docs.result }} |" >> $GITHUB_STEP_SUMMARY
