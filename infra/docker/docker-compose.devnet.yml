# =============================================================================
# Guts Devnet - 5 Node Test Network
# =============================================================================
#
# This configuration spins up a 5-node Guts network for extensive E2E testing.
# Use with the devnet-e2e-test.sh script for automated testing.
#
# Usage:
#   docker compose -f docker-compose.devnet.yml up -d
#   ./devnet-e2e-test.sh
#   docker compose -f docker-compose.devnet.yml down
#
# Ports:
#   Node 1: API=8081, P2P=9001
#   Node 2: API=8082, P2P=9002
#   Node 3: API=8083, P2P=9003
#   Node 4: API=8084, P2P=9004
#   Node 5: API=8085, P2P=9005
#
# =============================================================================

name: guts-devnet

services:
  # ==========================================================================
  # Node 1 - Bootstrap/Seed node
  # ==========================================================================
  node1:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    container_name: guts-devnet-node1
    hostname: node1
    ports:
      - "8081:8080"   # API
      - "9001:9000"   # P2P
    environment:
      - GUTS_NODE_ID=devnet-node1
      - GUTS_LOG_LEVEL=info
      - RUST_LOG=guts=info,tower_http=info
    volumes:
      - devnet-node1-data:/data
    networks:
      guts-devnet:
        aliases:
          - node1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ==========================================================================
  # Node 2
  # ==========================================================================
  node2:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    container_name: guts-devnet-node2
    hostname: node2
    ports:
      - "8082:8080"
      - "9002:9000"
    environment:
      - GUTS_NODE_ID=devnet-node2
      - GUTS_BOOTSTRAP_NODES=node1:9000
      - GUTS_LOG_LEVEL=info
      - RUST_LOG=guts=info,tower_http=info
    volumes:
      - devnet-node2-data:/data
    networks:
      guts-devnet:
        aliases:
          - node2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      node1:
        condition: service_healthy
    restart: unless-stopped

  # ==========================================================================
  # Node 3
  # ==========================================================================
  node3:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    container_name: guts-devnet-node3
    hostname: node3
    ports:
      - "8083:8080"
      - "9003:9000"
    environment:
      - GUTS_NODE_ID=devnet-node3
      - GUTS_BOOTSTRAP_NODES=node1:9000,node2:9000
      - GUTS_LOG_LEVEL=info
      - RUST_LOG=guts=info,tower_http=info
    volumes:
      - devnet-node3-data:/data
    networks:
      guts-devnet:
        aliases:
          - node3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      node1:
        condition: service_healthy
      node2:
        condition: service_healthy
    restart: unless-stopped

  # ==========================================================================
  # Node 4
  # ==========================================================================
  node4:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    container_name: guts-devnet-node4
    hostname: node4
    ports:
      - "8084:8080"
      - "9004:9000"
    environment:
      - GUTS_NODE_ID=devnet-node4
      - GUTS_BOOTSTRAP_NODES=node1:9000,node2:9000,node3:9000
      - GUTS_LOG_LEVEL=info
      - RUST_LOG=guts=info,tower_http=info
    volumes:
      - devnet-node4-data:/data
    networks:
      guts-devnet:
        aliases:
          - node4
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      node1:
        condition: service_healthy
      node2:
        condition: service_healthy
      node3:
        condition: service_healthy
    restart: unless-stopped

  # ==========================================================================
  # Node 5
  # ==========================================================================
  node5:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    container_name: guts-devnet-node5
    hostname: node5
    ports:
      - "8085:8080"
      - "9005:9000"
    environment:
      - GUTS_NODE_ID=devnet-node5
      - GUTS_BOOTSTRAP_NODES=node1:9000,node2:9000,node3:9000,node4:9000
      - GUTS_LOG_LEVEL=info
      - RUST_LOG=guts=info,tower_http=info
    volumes:
      - devnet-node5-data:/data
    networks:
      guts-devnet:
        aliases:
          - node5
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      node1:
        condition: service_healthy
      node2:
        condition: service_healthy
      node3:
        condition: service_healthy
      node4:
        condition: service_healthy
    restart: unless-stopped

networks:
  guts-devnet:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  devnet-node1-data:
  devnet-node2-data:
  devnet-node3-data:
  devnet-node4-data:
  devnet-node5-data:
