# =============================================================================
# Guts E2E Devnet - 4 Validator + 1 Observer Network with Full Consensus
# =============================================================================
#
# This configuration spins up a production-like BFT network for E2E testing:
#   - 4 validators: Form the consensus quorum (tolerates f=1 Byzantine node)
#   - 1 observer: Non-voting node that syncs state (tests light client scenario)
#
# The network runs with consensus ENABLED to test true decentralization.
#
# Usage:
#   docker compose -f docker-compose.e2e.yml up -d --build
#   ../scripts/devnet-e2e-orchestrate.sh
#   docker compose -f docker-compose.e2e.yml down -v
#
# Endpoints:
#   Validator 1: API=8081, P2P=9001 (Genesis validator, initial leader)
#   Validator 2: API=8082, P2P=9002
#   Validator 3: API=8083, P2P=9003
#   Validator 4: API=8084, P2P=9004
#   Observer:    API=8085, P2P=9005 (Non-voting sync node)
#
# =============================================================================

name: guts-e2e-devnet

x-common-env: &common-env
  GUTS_LOG_LEVEL: info
  GUTS_LOG_FORMAT: json
  RUST_LOG: guts=info,tower_http=info
  GUTS_CONSENSUS_ENABLED: "true"
  GUTS_CONSENSUS_GENESIS_FILE: "/etc/guts/genesis.json"
  GUTS_CONSENSUS_BLOCK_TIME_MS: "1000"
  GUTS_CONSENSUS_MAX_TXS_PER_BLOCK: "100"
  GUTS_CONSENSUS_MEMPOOL_MAX_TXS: "1000"
  GUTS_CONSENSUS_MEMPOOL_TTL_SECS: "300"
  GUTS_P2P_ENABLED: "true"
  GUTS_P2P_ADDR: "0.0.0.0:9000"

x-healthcheck: &healthcheck
  test: ["CMD", "curl", "-sf", "http://localhost:8080/health"]
  interval: 5s
  timeout: 3s
  retries: 10
  start_period: 10s

services:
  # ==========================================================================
  # Validator 1 - Genesis/Bootstrap Node
  # ==========================================================================
  validator1:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    image: guts-node:e2e-test
    container_name: guts-e2e-validator1
    hostname: validator1
    ports:
      - "8081:8080"
      - "9001:9000"
    environment:
      <<: *common-env
      GUTS_NODE_ID: e2e-validator1
      GUTS_VALIDATOR_NAME: validator1
      # Deterministic private key for devnet (seed=1)
      GUTS_PRIVATE_KEY: "0100000000000000000000000000000000000000000000000000000000000000"
    volumes:
      - ./genesis.e2e.json:/etc/guts/genesis.json:ro
      - e2e-validator1-data:/data
      - e2e-validator1-logs:/var/log/guts
    networks:
      guts-e2e-network:
        ipv4_address: 172.29.0.11
        aliases:
          - validator1
    healthcheck: *healthcheck
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

  # ==========================================================================
  # Validator 2
  # ==========================================================================
  validator2:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    image: guts-node:e2e-test
    container_name: guts-e2e-validator2
    hostname: validator2
    ports:
      - "8082:8080"
      - "9002:9000"
    environment:
      <<: *common-env
      GUTS_NODE_ID: e2e-validator2
      GUTS_VALIDATOR_NAME: validator2
      GUTS_PRIVATE_KEY: "0200000000000000000000000000000000000000000000000000000000000000"
      GUTS_BOOTSTRAP_NODES: validator1:9000
    volumes:
      - ./genesis.e2e.json:/etc/guts/genesis.json:ro
      - e2e-validator2-data:/data
      - e2e-validator2-logs:/var/log/guts
    networks:
      guts-e2e-network:
        ipv4_address: 172.29.0.12
        aliases:
          - validator2
    healthcheck: *healthcheck
    depends_on:
      validator1:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

  # ==========================================================================
  # Validator 3
  # ==========================================================================
  validator3:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    image: guts-node:e2e-test
    container_name: guts-e2e-validator3
    hostname: validator3
    ports:
      - "8083:8080"
      - "9003:9000"
    environment:
      <<: *common-env
      GUTS_NODE_ID: e2e-validator3
      GUTS_VALIDATOR_NAME: validator3
      GUTS_PRIVATE_KEY: "0300000000000000000000000000000000000000000000000000000000000000"
      GUTS_BOOTSTRAP_NODES: validator1:9000,validator2:9000
    volumes:
      - ./genesis.e2e.json:/etc/guts/genesis.json:ro
      - e2e-validator3-data:/data
      - e2e-validator3-logs:/var/log/guts
    networks:
      guts-e2e-network:
        ipv4_address: 172.29.0.13
        aliases:
          - validator3
    healthcheck: *healthcheck
    depends_on:
      validator1:
        condition: service_healthy
      validator2:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

  # ==========================================================================
  # Validator 4
  # ==========================================================================
  validator4:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    image: guts-node:e2e-test
    container_name: guts-e2e-validator4
    hostname: validator4
    ports:
      - "8084:8080"
      - "9004:9000"
    environment:
      <<: *common-env
      GUTS_NODE_ID: e2e-validator4
      GUTS_VALIDATOR_NAME: validator4
      GUTS_PRIVATE_KEY: "0400000000000000000000000000000000000000000000000000000000000000"
      GUTS_BOOTSTRAP_NODES: validator1:9000,validator2:9000,validator3:9000
    volumes:
      - ./genesis.e2e.json:/etc/guts/genesis.json:ro
      - e2e-validator4-data:/data
      - e2e-validator4-logs:/var/log/guts
    networks:
      guts-e2e-network:
        ipv4_address: 172.29.0.14
        aliases:
          - validator4
    healthcheck: *healthcheck
    depends_on:
      validator1:
        condition: service_healthy
      validator2:
        condition: service_healthy
      validator3:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

  # ==========================================================================
  # Observer Node (Non-voting, syncs state)
  # ==========================================================================
  observer:
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    image: guts-node:e2e-test
    container_name: guts-e2e-observer
    hostname: observer
    ports:
      - "8085:8080"
      - "9005:9000"
    environment:
      <<: *common-env
      GUTS_NODE_ID: e2e-observer
      GUTS_VALIDATOR_NAME: observer
      # Observer has no private key - it's a non-voting node
      GUTS_BOOTSTRAP_NODES: validator1:9000,validator2:9000,validator3:9000,validator4:9000
    volumes:
      - ./genesis.e2e.json:/etc/guts/genesis.json:ro
      - e2e-observer-data:/data
      - e2e-observer-logs:/var/log/guts
    networks:
      guts-e2e-network:
        ipv4_address: 172.29.0.15
        aliases:
          - observer
    healthcheck: *healthcheck
    depends_on:
      validator1:
        condition: service_healthy
      validator2:
        condition: service_healthy
      validator3:
        condition: service_healthy
      validator4:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "3"

networks:
  guts-e2e-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16
          gateway: 172.29.0.1

volumes:
  e2e-validator1-data:
  e2e-validator1-logs:
  e2e-validator2-data:
  e2e-validator2-logs:
  e2e-validator3-data:
  e2e-validator3-logs:
  e2e-validator4-data:
  e2e-validator4-logs:
  e2e-observer-data:
  e2e-observer-logs:
