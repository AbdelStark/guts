# Alertmanager Configuration
# See: https://prometheus.io/docs/alerting/latest/configuration/

global:
  # The smarthost and SMTP sender used for mail notifications
  # smtp_smarthost: 'smtp.example.com:587'
  # smtp_from: 'alertmanager@example.com'
  # smtp_auth_username: 'alertmanager'
  # smtp_auth_password: 'password'

  # Slack webhook URL
  # slack_api_url: 'https://hooks.slack.com/services/XXX/YYY/ZZZ'

  # PagerDuty integration key
  # pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

  resolve_timeout: 5m

# Route tree
route:
  # Default receiver
  receiver: 'default-receiver'

  # Group alerts by these labels
  group_by: ['alertname', 'severity', 'instance']

  # Wait before sending first alert
  group_wait: 30s

  # Wait before sending updates
  group_interval: 5m

  # Wait before resending
  repeat_interval: 4h

  # Child routes
  routes:
    # Critical alerts go to PagerDuty
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      group_wait: 10s
      repeat_interval: 1h

    # Warning alerts go to Slack
    - match:
        severity: warning
      receiver: 'slack-warnings'
      group_wait: 1m
      repeat_interval: 4h

    # Consensus alerts - special handling
    - match:
        alertname: GutsConsensusStalled
      receiver: 'consensus-team'
      group_wait: 10s
      repeat_interval: 15m

    # Validator alerts
    - match:
        job: guts-validators
      receiver: 'validator-team'
      group_wait: 30s
      repeat_interval: 1h

# Inhibit rules - suppress alerts when parent alert is firing
inhibition_rules:
  # If node is down, suppress other alerts for that node
  - source_match:
      alertname: 'GutsNodeDown'
    target_match_re:
      alertname: 'Guts.*'
    equal: ['instance']

  # If consensus stalled, suppress individual validator alerts
  - source_match:
      alertname: 'GutsConsensusStalled'
    target_match:
      alertname: 'GutsValidatorDown'

# Receivers
receivers:
  - name: 'default-receiver'
    # Webhook for generic alerts
    webhook_configs:
      - url: 'http://alert-handler:8080/webhook'
        send_resolved: true

  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: '<pagerduty-service-key>'
        severity: critical
        description: '{{ .CommonAnnotations.summary }}'
        details:
          firing: '{{ template "pagerduty.default.instances" .Alerts.Firing }}'
          num_firing: '{{ .Alerts.Firing | len }}'

  - name: 'slack-warnings'
    slack_configs:
      - api_url: '<slack-webhook-url>'
        channel: '#guts-alerts'
        send_resolved: true
        title: '{{ .Status | toUpper }}: {{ .CommonAnnotations.summary }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'

  - name: 'consensus-team'
    slack_configs:
      - api_url: '<slack-webhook-url>'
        channel: '#guts-consensus'
        send_resolved: true
        title: 'ðŸš¨ CONSENSUS: {{ .CommonAnnotations.summary }}'
        text: '{{ .CommonAnnotations.description }}'
    pagerduty_configs:
      - service_key: '<pagerduty-consensus-key>'
        severity: critical

  - name: 'validator-team'
    slack_configs:
      - api_url: '<slack-webhook-url>'
        channel: '#guts-validators'
        send_resolved: true
        title: 'Validator Alert: {{ .CommonAnnotations.summary }}'
        text: '{{ .CommonAnnotations.description }}'

# Templates
templates:
  - '/etc/alertmanager/templates/*.tmpl'
